@page "/items"
@using Microsoft.AspNetCore.Components.Authorization
@using AzDoBoards.Client.Models
@using AzDoBoards.Data.Abstractions
@using AzDoBoards.Ui.Services
@using AzDoBoards.Utility
@using MudBlazor
@inject HierarchyService HierarchyService
@inject ISnackbar Snackbar
@inject ILogger<Items> Logger

<PageTitle>Items</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Work Items</MudText>

    @if (isLoading)
    {
        <MudStack Row AlignItems="AlignItems.Center" Class="my-4">
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            <MudText Typo="Typo.body2" Class="ml-2">Loading work item hierarchy...</MudText>
        </MudStack>
    }
    else if (workItemHierarchy?.Any() == true)
    {
        <!-- Dynamic flexible layout instead of fixed grid -->
        <div class="hierarchy-flex-container">
            @for (int levelIndex = 0; levelIndex < workItemHierarchy.Count; levelIndex++)
            {
                var level = levelIndex;
                var levelItems = workItemHierarchy[level];

                <!-- Dynamically sized selectable box containing work items -->
                <MudPaper Class="@GetLevelColumnClass(level)" 
                          Style="@GetLevelBoxStyle(selectedLevel == level)" 
                          @onclick="@(() => SelectLevel(level))">
                    
                    <!-- Work Item Types arranged side-by-side -->
                    <div class="work-items-horizontal-container pa-2">
                        @if (levelItems.Any())
                        {
                            @foreach (var workItem in levelItems)
                            {
                                <div class="work-item-chip-horizontal" style="@GetWorkItemChipStyle(workItem)">
                                    <div class="d-flex align-center pa-1">
                                        <MudIcon Icon="@WorkItemHelper.GetWorkItemTypeSvgIcon(workItem.Name)" Size="Size.Small" Class="mr-1" />
                                        <MudText Typo="Typo.caption" Class="work-item-text">@workItem.Name</MudText>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-level-placeholder">
                                <MudText Typo="Typo.caption" Class="text-center">No work items</MudText>
                            </div>
                        }
                    </div>
                </MudPaper>
            }
        </div>

        @if (selectedLevel >= 0)
        {
            <MudAlert Severity="Severity.Success" Class="mt-4">
                <MudStack Row AlignItems="AlignItems.Center">
                    <MudText>
                        You have selected <strong>Level @(selectedLevel + 1)</strong> with @(workItemHierarchy[selectedLevel].Count) work item type(s):
                        <strong>@string.Join(", ", workItemHierarchy[selectedLevel].Select(w => w.Name))</strong>
                    </MudText>
                </MudStack>
            </MudAlert>
        }
    }
    else if (!isLoading)
    {
        <MudAlert Severity="Severity.Warning" Class="my-4">
            <MudStack>
                <MudText>
                    <MudIcon Icon="Icons.Material.Filled.Warning" Class="mr-2" />
                    No work item hierarchy configured
                </MudText>
                <MudText Typo="Typo.body2" Class="mt-2">
                    Please configure your work item hierarchy in the Settings page first.
                </MudText>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Primary" 
                          StartIcon="Icons.Material.Filled.Settings"
                          Href="/settings"
                          Class="mt-2 align-self-start">
                    Go to Settings
                </MudButton>
            </MudStack>
        </MudAlert>
    }
</MudContainer>

@code {
    private bool isLoading = true;
    private List<List<WorkItemTypeSummary>>? workItemHierarchy;
    private int selectedLevel = -1;

    protected override async Task OnInitializedAsync()
    {
        await LoadHierarchyDataAsync();
    }

    private async Task LoadHierarchyDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            // Get current process ID
            var processId = await HierarchyService.GetCurrentProcessIdAsync();
            if (string.IsNullOrEmpty(processId))
            {
                return;
            }

            // Load work item types
            var workItemTypes = await HierarchyService.LoadWorkItemTypesAsync(processId);
            if (workItemTypes == null)
            {
                return;
            }

            // Load hierarchy
            workItemHierarchy = await HierarchyService.LoadHierarchyAsync(processId, workItemTypes);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading hierarchy data");
            Snackbar.Add("Error loading work item hierarchy", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void SelectLevel(int level)
    {
        selectedLevel = selectedLevel == level ? -1 : level;
        StateHasChanged();
        
        // Fire event for level selection (can be extended later)
        Logger.LogInformation("Level {Level} selected", level);
    }

    private string GetLevelColumnClass(int level)
    {
        return "level-box-selectable level-box-dynamic";
    }

    private string GetLevelBoxStyle(bool isSelected)
    {
        var baseStyle = "cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; " +
                       "border-radius: 8px; min-height: 60px; max-height: 80px; overflow: hidden;";
        
        if (isSelected)
        {
            baseStyle += " border: 3px solid white; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);";
        }
        else
        {
            baseStyle += " border: 1px solid rgba(0, 0, 0, 0.1);";
        }

        return baseStyle;
    }

    private string GetWorkItemChipStyle(WorkItemTypeSummary workItem)
    {
        var baseColor = !string.IsNullOrEmpty(workItem.Color) ? workItem.Color : "#1976d2";
        return $"background-color: {baseColor}; color: white; " +
               $"border-radius: 4px; " +
               $"transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.2);";
    }
}
